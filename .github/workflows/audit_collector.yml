# =============================================================================
# WORKFLOW: Codey Audit Collector - [Codey Audit Collector]
# PART OF:  Codey - No Mercy EDITION
# =============================================================================
# Role:        Automated Audit & Compliance (ESOL v1.1)
# Copyright:   (c) 2026 VolkanSah
# License:     Apache 2.0 + ESOL v1.1 (https://github.com/VolkanSah/ESOL)
# Enforcement: Jurisdiction Berlin, Germany (StGB & DSGVO)
# =============================================================================

# Define the display name for the GitHub Actions dashboard
name: "Codey Audit Collector"

# Trigger: Only manual execution via the 'Run workflow' button
on:
  workflow_dispatch:

# Permissions: Grant the runner write access to commit files back to the repo
permissions:
  contents: write

jobs:
  # Main job for data collection
  collect-audit:
    # Use the standard Ubuntu environment
    runs-on: ubuntu-latest
    steps:
      # Step 1: Download the repository code to the runner
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # Uses a custom PAT (Personal Access Token) for higher API limits/permissions
          token: ${{ secrets.GIT_TOKEN }}

      # Step 2: Initialize the Python interpreter
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          # Stick to version 3.10 for compatibility
          python-version: '3.10'

      # Step 3: Interaction with GitHub API and local script execution
      - name: Fetch and Format Audit Data
        env:
          # Provide the secret token to the GitHub CLI (gh) environment
          GH_TOKEN: ${{ secrets.GIT_TOKEN }}
        run: |
          # Create a hidden directory to store raw audit results
          mkdir -p .codey_audit

          # 1. Fetch REST Data: Log rate limits, user details, and workflow status
          gh api /rate_limit > .codey_audit/rate_limit.json
          gh api /user > .codey_audit/user_info.json
          gh api /repos/${{ github.repository }}/actions/workflows > .codey_audit/workflows.json
          
          # 2. Fetch GraphQL Data: Advanced query for disk usage and star counts
          gh api graphql -f query='query { viewer { login } repository(owner: "${{ github.repository_owner }}", name: "${{ github.event.repository.name }}") { diskUsage stargazers { totalCount } } }' > .codey_audit/graphql_check.json
          
          # 3. Run the "No Mercy" formatter: Transform raw JSON into the final report
          python3 .codey_audit/scripts/format_audit.py

      # Step 4: Finalize the audit by pushing the report to the repository
      - name: Commit and Push Changes
        run: |
          # Identity setup for the git history
          git config user.name "Codey Audit Bot"
          git config user.email "audit@codey.lab"
          
          # Stage only the generated Markdown report
          git add .codey_audit/AUDIT_DATA.md
          
          # Commit the report; [skip ci] prevents an infinite loop of workflows
          git commit -m "Update Codey Audit Data [skip ci]" || echo "No changes to commit"
          
          # Upload the changes to the main branch
          git push
